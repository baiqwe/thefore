# 📋 图片管理系统 - 需求文档

## 1. 项目概述

### 1.1 背景
为 Wiki 网站（Next.js + TypeScript）构建一个完整的图片管理系统，支持从 YouTube 视频自动提取截图并智能关联到文章章节，实现内容的可视化增强。

### 1.2 目标
- 自动化图片获取流程，减少手动配图工作量
- 支持多种图片来源（本地、外部URL、AI生成、视频截图）
- 实现图片与文章内容的智能关联
- 提供灵活的图片管理和更新机制

## 2. 功能需求

### 2.1 图片管理核心功能

#### 2.1.1 图片存储结构
```
public/images/
├── guides/          # 指南封面图 (1200x630px)
├── items/           # 物品图片 (800x600px)
└── quests/          # 任务图片 (1200x630px)
```

**要求：**
- 图片按类型分类存储
- 统一命名规则：`{slug}.jpg` 或 `{slug}-{section}.jpg`
- 支持 JPG/PNG 格式
- 单个图片文件大小不超过 500KB

#### 2.1.2 图片优先级系统
系统按以下优先级查找图片：
1. **本地图片** - `public/images/{type}/{slug}.jpg`（最高优先级）
2. **外部URL** - JSON 数据中的 `coverImage` 或 `image` 字段
3. **占位符** - 自动生成的占位符图片（开发阶段）

#### 2.1.3 图片工具函数
- `getGuideCoverImage(slug, fallbackUrl?)` - 获取指南封面图配置
- `getItemImage(slug, fallbackUrl?)` - 获取物品图片配置
- `getPlaceholderImage(width, height, text?)` - 生成占位符URL
- `imageExists(src)` - 检查图片是否存在（客户端）

### 2.2 自动图片提取功能

#### 2.2.1 YouTube 视频搜索
**功能：**
- 根据文章标题和描述自动搜索 YouTube 视频
- 支持关键词匹配和相关性排序
- 显示搜索结果供用户选择
- 支持手动指定视频 URL

**搜索策略：**
```
搜索查询 = "{文章标题} {文章描述} The Forge Roblox"
```

**技术要求：**
- 使用 `yt-dlp` 工具（无需 YouTube API Key）
- 返回前5个最相关结果
- 显示视频标题、URL、时长等信息

#### 2.2.2 视频下载与处理
**功能：**
- 自动下载视频（限制最高1080p以节省时间）
- 保存到临时目录
- 支持断点续传
- 下载完成后自动清理临时文件

**技术要求：**
- 使用 `yt-dlp` 下载
- 支持多种视频格式和质量选择
- 错误处理和重试机制

#### 2.2.3 关键帧提取
**功能：**
- 从视频中提取关键帧作为图片素材
- 可配置提取频率（默认每10秒一帧）
- 自动裁剪和调整尺寸
- 生成封面图和章节图片

**提取策略：**
- **封面图**：使用视频第一帧，裁剪为 1200x630px
- **章节图片**：平均分配帧到各个章节，裁剪为 800x600px
- 支持自定义提取时间点

**技术要求：**
- 使用 `ffmpeg` 进行视频处理
- 支持批量处理
- 图片质量优化（压缩、格式转换）

#### 2.2.4 图片与章节关联
**功能：**
- 自动将提取的图片分配给文章章节
- 生成图片映射文件（JSON格式）
- 支持手动调整关联关系

**关联规则：**
- 封面图：固定使用第一帧
- 章节图片：按章节顺序平均分配帧
- 文件名规则：`{guide-slug}-{section-slug}.jpg`

### 2.3 数据更新功能

#### 2.3.1 自动更新 JSON 数据
**功能：**
- 读取图片映射文件
- 自动更新 `guides.json` 或 `items.json`
- 添加图片路径到对应字段

**数据结构：**
```json
{
  "slug": "race-tier-list",
  "title": "...",
  "coverImage": "/images/guides/race-tier-list.jpg",
  "content": [
    {
      "section": "Getting Started",
      "image": "/images/guides/race-tier-list-getting-started.jpg",
      "text": "..."
    }
  ]
}
```

#### 2.3.2 图片映射文件
**格式：**
```json
{
  "guideSlug": "race-tier-list",
  "coverImage": "race-tier-list.jpg",
  "sectionImages": {
    "Getting Started": "race-tier-list-getting-started.jpg",
    "Essential Items": "race-tier-list-essential-items.jpg"
  }
}
```

### 2.4 UI 组件需求

#### 2.4.1 指南封面图组件
**功能：**
- 显示指南封面图
- 自动处理图片加载失败
- 显示占位符（加载失败时）
- 响应式设计

**属性：**
- `slug: string` - 指南slug
- `title: string` - 指南标题
- `fallbackUrl?: string` - 外部URL（可选）
- `className?: string` - 自定义样式

#### 2.4.2 章节图片组件
**功能：**
- 显示章节配图
- 懒加载优化
- 自动隐藏加载失败的图片
- 响应式布局

**属性：**
- `src: string` - 图片路径
- `alt: string` - 替代文本
- `className?: string` - 自定义样式

#### 2.4.3 页面集成
- 指南列表页：显示封面图缩略图
- 指南详情页：显示封面图 + 章节图片
- 物品页面：显示物品图片

### 2.5 辅助工具功能

#### 2.5.1 占位符生成工具
**功能：**
- 批量生成占位符图片
- 为所有指南生成初始占位符
- 使用占位符服务（via.placeholder.com）

#### 2.5.2 视频帧提取脚本
**功能：**
- 从指定 YouTube 视频提取关键帧
- 保存到临时目录
- 供用户手动选择最佳帧

#### 2.5.3 依赖检查工具
**功能：**
- 检查必要工具是否安装（yt-dlp, ffmpeg）
- 提供安装指引
- 验证安装状态

#### 2.5.4 测试工具
**功能：**
- 模拟图片提取流程
- 显示将生成的图片列表
- 验证系统配置

## 3. 非功能需求

### 3.1 性能要求
- 图片加载时间 < 2秒（正常网络）
- 支持懒加载
- 图片自动优化（Next.js Image 组件）
- 支持 CDN 部署

### 3.2 兼容性要求
- 支持现代浏览器（Chrome, Firefox, Safari, Edge）
- 响应式设计（移动端 + 桌面端）
- 支持暗色模式

### 3.3 可维护性
- 清晰的代码结构
- 完善的文档
- 易于扩展新功能
- 错误处理和日志记录

### 3.4 安全性
- 不直接使用 Google 图片搜索 API（避免版权风险）
- 视频来源可追溯
- 支持外部 URL 验证

## 4. 数据需求

### 4.1 图片规格
| 类型 | 尺寸 | 格式 | 最大大小 | 比例 |
|------|------|------|----------|------|
| 指南封面 | 1200x630px | JPG | 500KB | 16:9 |
| 章节图片 | 800x600px | JPG | 300KB | 4:3 |
| 物品图片 | 800x600px | JPG | 300KB | 4:3 |

### 4.2 数据字段扩展
需要在现有 JSON 数据结构中添加：
- `coverImage?: string` - 封面图路径或URL
- `content[].image?: string` - 章节图片路径或URL

## 5. 工作流程

### 5.1 自动化流程
1. 用户运行提取脚本：`node scripts/auto-extract-guide-images.js <slug>`
2. 系统搜索相关 YouTube 视频
3. 下载视频到临时目录
4. 提取关键帧
5. 处理和裁剪图片
6. 保存到图片目录
7. 生成映射文件
8. 用户运行更新脚本：`node scripts/update-guide-images.js <slug>`
9. 系统更新 JSON 数据
10. 完成

### 5.2 半自动流程
1. 用户手动提供视频 URL
2. 系统下载并提取
3. 用户选择最佳图片
4. 系统保存并更新数据

### 5.3 手动流程
1. 用户手动准备图片（AI生成/截图）
2. 保存到对应目录
3. 在 JSON 中添加路径
4. 完成

## 6. 技术约束

### 6.1 依赖工具
- **yt-dlp**: YouTube 视频下载工具
  - 安装：`pip install yt-dlp`
  - 用途：搜索和下载视频
- **ffmpeg**: 视频处理工具
  - 安装：`brew install ffmpeg` (macOS)
  - 用途：提取帧、裁剪、格式转换

### 6.2 环境要求
- Node.js 18+
- Python 3.9+ (for yt-dlp)
- 足够的磁盘空间（每个视频可能几百MB）
- 稳定的网络连接

## 7. 未来扩展

### 7.1 计划功能
- AI 图片生成集成（DALL-E 3）
- 图片自动优化和压缩
- 批量处理多个指南
- 图片版本管理
- CDN 集成

### 7.2 优化方向
- 更智能的帧选择算法
- 图片内容识别和匹配
- 自动生成图片描述（alt text）
- 图片相似度检测（去重）



